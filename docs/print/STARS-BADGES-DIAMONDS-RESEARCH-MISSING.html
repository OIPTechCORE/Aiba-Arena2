<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>STARS BADGES DIAMONDS RESEARCH MISSING ‚Äî Aiba Arena Docs</title>
  <link rel="stylesheet" href="../print.css"/>
</head>
<body>
  <div class="doc-header">
    <h1>STARS BADGES DIAMONDS RESEARCH MISSING</h1>
    <p class="doc-meta no-print"><a href="index.html">‚Üê All docs</a></p>
  </div>
  <div class="doc-body">
<h1>Deep Research: What Was Missing (Stars, Badges, Diamonds)</h1>
<p>After implementing Stars, Profile Badges, and Diamonds per the plan, this document captures <strong>gaps</strong> found via codebase audit, plan re-read, and alignment with Telegram/X product patterns.</p>
<hr/>
<h2>1. Plan vs implementation</h2>
<table>
<thead><tr>
<th>Plan requirement</th>
<th>Status</th>
<th>Notes</th>
</tr></thead>
<tbody>
<tr>
<td>Stars: &quot;Every <strong>battle win</strong> grants Stars&quot;</td>
<td><strong>Gap</strong></td>
<td>Implemented as &quot;every battle&quot;; plan says <em>win</em> (score &gt; 0).</td>
</tr>
<tr>
<td>Leaderboard: &quot;badge icon next to username&quot;</td>
<td><strong>Missing</strong></td>
<td>Leaderboard API does not return <code>badges</code>; UI does not render them.</td>
</tr>
<tr>
<td>Profile card: &quot;Avatar placeholder, <strong>username</strong>&quot;</td>
<td><strong>Missing</strong></td>
<td>Only badges shown; no Telegram username/avatar.</td>
</tr>
<tr>
<td>&quot;Balance strip or header: Optional small <strong>verified</strong> badge&quot;</td>
<td><strong>Missing</strong></td>
<td>No verified indicator next to balance.</td>
</tr>
<tr>
<td>&quot;Optional <strong>auto-award</strong> (e.g. top 10 ‚Üí top_leader)&quot;</td>
<td><strong>Missing</strong></td>
<td>No cron or hook to assign <code>top_leader</code> from leaderboard.</td>
</tr>
<tr>
<td>Push notification: battle win</td>
<td><strong>Partial</strong></td>
<td><code>notifyBattleWin</code> does not mention Stars or Diamond.</td>
</tr>
</tbody></table>
<hr/>
<h2>2. Backend gaps</h2>
<ul>
<li><strong>Stars eligibility</strong>: Plan says &quot;battle <strong>win</strong>&quot;; code credits stars on every battle. Should credit only when <code>score &gt; 0</code>.</li>
<li><strong>Charity leaderboard</strong>: Returns <code>telegramId</code> and amounts only; no user lookup for <code>badges</code> (optional enhancement).</li>
<li><strong>Admin</strong>: No read-only view of a user‚Äôs stars/diamonds/badges (admin credit-user and mod badges are write-only). Optional: user detail or ledger filter by currency (Stars/Diamonds not in ledger today‚ÄîMVP earn/display only).</li>
</ul>
<hr/>
<h2>3. Miniapp gaps</h2>
<ul>
<li><strong>Profile card</strong>: Shows badges only. Should show Telegram display name/username from <code>getTelegramUserUnsafe()</code> (no API change).</li>
<li><strong>Balance strip / header</strong>: No small &quot;verified&quot; badge when user has <code>verified</code> in <code>economyMe.badges</code>.</li>
</ul>
<hr/>
<h2>4. Notifications</h2>
<ul>
</ul>
<hr/>
<h2>5. External / product alignment</h2>
<ul>
<li><strong>Telegram Diamonds / TON</strong>: &quot;Diamonds&quot; in TON/Fragment context often refers to premium usernames/NFTs. Our in-app &quot;Diamonds&quot; are a separate premium currency (first win, etc.); naming is fine, no product gap.</li>
<li><strong>X (Twitter) badges</strong>: Shown on profile and next to names in replies/timeline. We add profile card and leaderboard badges to match.</li>
</ul>
<hr/>
<h2>6. Fixes applied (after this research) ‚úÖ</h2>
<ol>
<li><strong>Leaderboard</strong>: Added <code>badges</code> to aggregation <code>$project</code> in <code>GET /api/leaderboard</code>; miniapp leaderboard rows render badge pills (up to 3 per row, <code>.badge-pill--inline</code>).</li>
<li><strong>notifyBattleWin</strong>: Now accepts <code>starsGranted</code>, <code>firstWinDiamond</code>; message includes &quot;‚≠ê +X Stars&quot; and &quot;üíé +N Diamond (first win!)&quot; when present.</li>
<li><strong>Profile card</strong>: Shows Telegram display name (username or first_name + last_name) from <code>getTelegramUserUnsafe()</code> above badges.</li>
<li><strong>Verified in strip</strong>: Small cyan &quot;‚úì&quot; badge shown at start of balance strip when <code>economyMe.badges</code> includes <code>verified</code> (<code>.balance-strip__verified</code>).</li>
<li><strong>Charity leaderboard badges</strong> (optional): Omit for MVP; can add user lookup + badges later.</li>
<li><strong>Auto-award top_leader</strong> (optional): Defer; requires cron or post-battle hook and leaderboard query.</li>
</ol>
<hr/>
<h2>7. Optional / future</h2>
<ul>
<li>Admin &quot;user detail&quot; showing stars, diamonds, badges.</li>
<li>Charity leaderboard: include user badges.</li>
<li>Auto-assign <code>top_leader</code> for top N by score (scheduled job or on rank fetch).</li>
</ul>
  </div>
</body>
</html>