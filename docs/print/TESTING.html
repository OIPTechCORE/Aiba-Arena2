<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>TESTING — Aiba Arena Docs</title>
        <link rel="stylesheet" href="../print.css" />
    </head>
    <body>
        <div class="doc-header">
            <h1>TESTING</h1>
            <p class="doc-meta no-print"><a href="index.html">← All docs</a></p>
        </div>
        <div class="doc-body">
            <h1>Automated Testing — AIBA Arena</h1>
            <p>
                This document describes how to run <strong>deep automated tests</strong> so every part of the app is
                verified before release. No user should find a broken button or non-functioning feature.
            </p>
            <hr />
            <h2>1. Backend tests</h2>
            <p>All backend tests use Node’s built-in test runner (<code>node --test</code>).</p>
            <h3>1.1 Unit tests (no database)</h3>
            <p>Engine, utilities, and security logic:</p>
            <pre><code>cd backend
npm run test:unit</code></pre>
            <p>
                This runs everything under <code>backend/tests/</code> (battle engine, economy window, idempotency, rate
                limit, telegram policy, etc.).
            </p>
            <h3>1.2 API tests (no database)</h3>
            <p>Health, catalogs, university, auth, and validation. <strong>No MongoDB required.</strong></p>
            <pre><code>cd backend
npm run test:api</code></pre>
            <p>Covers:</p>
            <ul>
                <li>
                    <strong>Catalogs:</strong> <code>GET /api/marketplace/system-brokers</code>,
                    <code>GET /api/car-racing/system-cars</code>, <code>GET /api/bike-racing/system-bikes</code>
                </li>
                <li><strong>University:</strong> <code>GET /api/university/courses</code></li>
                <li><strong>Auth:</strong> <code>GET/POST /api/brokers/*</code> without auth → 401</li>
                <li><strong>Validation:</strong> invalid body for buy-system-broker, referrals/use → 400/422</li>
            </ul>
            <h3>1.3 API integration tests (with in-memory MongoDB)</h3>
            <p>
                Full flows: create broker, economy/me, referrals, daily, leaderboard, marketplace listings, car/bike
                racing, university progress, announcements.
            </p>
            <p>
                <strong>Requires:</strong> <code>mongodb-memory-server</code> (install with
                <code>npm install -D mongodb-memory-server</code> in <code>backend</code>).
            </p>
            <pre><code>cd backend
npm install -D mongodb-memory-server
npm run test:api:integration</code></pre>
            <p>
                If <code>mongodb-memory-server</code> is not installed, integration tests are skipped without failing.
            </p>
            <h3>1.4 Run all backend tests</h3>
            <pre><code>cd backend
npm test</code></pre>
            <p>
                This runs the default <code>node --test</code> (all <code>*.test.js</code> under
                <code>backend/tests/</code>).
            </p>
            <hr />
            <h2>2. Miniapp (frontend)</h2>
            <h3>2.1 Build test</h3>
            <p>Ensures the miniapp compiles and has no build-time errors:</p>
            <pre><code>cd miniapp
npm run build</code></pre>
            <p>Add this to CI so broken imports or syntax are caught.</p>
            <h3>2.2 Manual / E2E (optional)</h3>
            <p>For full “click every button” coverage, run the app locally and use:</p>
            <ul>
                <li>
                    <strong>Backend:</strong> <code>http://localhost:5000</code> (after <code>npm start</code> in
                    <code>backend</code>)
                </li>
            </ul>
            <p>
                Set <code>NEXT_PUBLIC_BACKEND_URL=http://localhost:5000</code> and <code>APP_ENV=dev</code> for local
                backend.
            </p>
            <hr />
            <h2>3. Contracts (Blueprint / Jest)</h2>
            <p>From repo root:</p>
            <pre><code>npm test</code></pre>
            <p>This builds contracts and runs Jest tests in <code>tests/*.spec.ts</code>.</p>
            <hr />
            <h2>4. Recommended CI pipeline</h2>
            <ol>
                <li>- <code>cd backend &amp;&amp; npm run test:unit</code></li>
                <li>- <code>cd backend &amp;&amp; npm run test:api</code></li>
                <li>
                    - (Optional) <code>cd backend &amp;&amp; npm run test:api:integration</code> (with
                    <code>mongodb-memory-server</code> installed)
                </li>
                <li><strong>Miniapp</strong></li>
                <li>- <code>cd miniapp &amp;&amp; npm run build</code></li>
                <li><strong>Contracts</strong></li>
                <li>- <code>npm run build:contracts &amp;&amp; jest --verbose</code> (from root)</li>
            </ol>
            <hr />
            <h2>5. What each test file covers</h2>
            <table>
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Purpose</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>backend/tests/api/health.test.js</code></td>
                        <td>Health, comms status, metrics</td>
                    </tr>
                    <tr>
                        <td><code>backend/tests/api/catalog.test.js</code></td>
                        <td>System shop catalogs (brokers, cars, bikes)</td>
                    </tr>
                    <tr>
                        <td><code>backend/tests/api/university.test.js</code></td>
                        <td>University courses endpoint</td>
                    </tr>
                    <tr>
                        <td><code>backend/tests/api/auth.test.js</code></td>
                        <td>401 when auth missing on protected routes</td>
                    </tr>
                    <tr>
                        <td><code>backend/tests/api/validation.test.js</code></td>
                        <td>400/422 for invalid request bodies</td>
                    </tr>
                    <tr>
                        <td><code>backend/tests/api/integration.test.js</code></td>
                        <td>
                            Full API with DB: brokers, economy, referrals, daily, leaderboard, marketplace, car/bike,
                            university progress, announcements
                        </td>
                    </tr>
                    <tr>
                        <td><code>backend/tests/battleEngine.test.js</code></td>
                        <td>Battle simulation logic</td>
                    </tr>
                    <tr>
                        <td><code>backend/tests/economyWindow.test.js</code></td>
                        <td>Economy window logic</td>
                    </tr>
                    <tr>
                        <td>… (other engine/unit tests)</td>
                        <td>Idempotency, rate limit, telegram policy, etc.</td>
                    </tr>
                </tbody>
            </table>
            <hr />
            <h2>6. Adding new tests</h2>
            <ul>
                <li>
                    <strong>New engine/utility:</strong> Add <code>backend/tests/&lt;name&gt;.test.js</code> and use
                    <code>node:test</code> + <code>node:assert/strict</code>.
                </li>
                <li>
                    <strong>New miniapp page/flow:</strong> Ensure <code>miniapp</code> build still passes; add E2E
                    later if needed.
                </li>
            </ul>
            <p>Running these tests before every release keeps the game reliable for the community.</p>
            <hr />
            <h2>7. Extended test plan (Realms, Assets, Governance, etc.)</h2>
            <p>
                <strong>Scope:</strong> Realms, Missions, Mentors, Assets, Asset Marketplace, Governance, Treasury Ops.
            </p>
            <h3>Backend API checks</h3>
            <ul>
                <li><code>GET /api/missions?realmKey=...</code> — missions</li>
                <li><code>POST /api/missions/complete</code> — rewards AIBA/NEUR</li>
                <li><code>GET /api/mentors</code>, <code>POST /api/mentors/assign</code></li>
                <li>
                    <code>POST /api/assets/mint</code>, <code>POST /api/assets/upgrade</code>,
                    <code>GET /api/assets/mine</code>
                </li>
                <li><code>POST /api/asset-marketplace/list</code>, <code>buy</code>, <code>rent</code></li>
                <li>
                    <code>GET /api/governance/proposals</code>, <code>POST /api/governance/propose</code>,
                    <code>POST /api/governance/vote</code>
                </li>
                <li><code>GET /api/treasury/ops</code> — burn/treasury/rewards/staking ledger</li>
            </ul>
            <h3>Miniapp UX checks</h3>
            <ul>
                <li>Realms: realm select, mission list, complete mission updates balances</li>
                <li>Mentors: assign mentor, status message updates</li>
                <li>Assets: mint, upgrade, list, buy, rent flows</li>
                <li>Governance: propose and vote flows</li>
            </ul>
            <h3>Admin checks</h3>
            <ul>
                <li>Marketplace tab: metrics load</li>
                <li>Treasury Ops tab: metrics load</li>
            </ul>
            <h3>Contracts</h3>
            <ul></ul>
        </div>
    </body>
</html>
