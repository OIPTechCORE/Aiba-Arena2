<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>API CONTRACT — Aiba Arena Docs</title>
  <link rel="stylesheet" href="../print.css"/>
</head>
<body>
  <div class="doc-header">
    <h1>API CONTRACT</h1>
    <p class="doc-meta no-print"><a href="index.html">← All docs</a></p>
  </div>
  <div class="doc-body">
<h1>API Contract — Multiverse Expansion</h1>
<p><strong>Version:</strong> Feb 2025 <strong>Status:</strong> Phase 1 baseline (schemas + endpoints for new systems).</p>
<p>This document defines the <strong>API surface</strong> for Realms, Missions, Mentors, Assets, Marketplace, Governance, and Treasury telemetry.</p>
<hr/>
<h2>1) Realms &amp; Missions</h2>
<p><strong>GET</strong> <code>/api/realms</code> Returns <code>{ realms: Realm[] }</code></p>
<p><strong>GET</strong> <code>/api/realms/:key</code> Returns <code>{ realm: Realm }</code></p>
<p><strong>GET</strong> <code>/api/missions?realmKey=...</code> Returns <code>{ missions: Mission[] }</code></p>
<p><strong>POST</strong> <code>/api/missions/complete</code> Body: <code>{ missionId }</code> Returns <code>{ ok: true, rewardAiba, rewardNeur, xp }</code></p>
<hr/>
<h2>2) Mentors</h2>
<p><strong>GET</strong> <code>/api/mentors</code> Returns <code>{ mentors: Mentor[] }</code></p>
<p><strong>POST</strong> <code>/api/mentors/assign</code> Body: <code>{ mentorId }</code> Returns <code>{ ok: true }</code></p>
<p><strong>POST</strong> <code>/api/mentors/upgrade</code> Body: <code>{ mentorId }</code> Returns <code>{ ok: true, costAiba }</code></p>
<hr/>
<h2>3) Assets &amp; Marketplace</h2>
<p><strong>POST</strong> <code>/api/assets/mint</code> Body: <code>{ category, name, realmKey, metadataUri }</code> Returns <code>{ asset }</code></p>
<p><strong>POST</strong> <code>/api/assets/upgrade</code> Body: <code>{ assetId }</code> Returns <code>{ asset }</code></p>
<p><strong>GET</strong> <code>/api/assets/mine</code> Returns <code>{ assets: Asset[] }</code></p>
<h3>3a) Broker Marketplace (Brokers)</h3>
<p><strong>GET</strong> <code>/api/marketplace/listings</code> Query: <code>limit</code> Returns <code>Listing[]</code></p>
<p><strong>POST</strong> <code>/api/marketplace/list</code> Body: <code>{ brokerId, priceAIBA, priceNEUR }</code> Returns <code>Listing</code></p>
<p><strong>POST</strong> <code>/api/marketplace/delist</code> Body: <code>{ listingId }</code> Returns <code>{ ok: true, listing }</code></p>
<p><strong>POST</strong> <code>/api/marketplace/buy</code> Body: <code>{ listingId, requestId }</code> Returns <code>{ ok: true, broker, listingId }</code></p>
<p><strong>GET</strong> <code>/api/marketplace/system-brokers</code> — Catalog of brokers sold by system (AIBA). <strong>POST</strong> <code>/api/marketplace/buy-system-broker</code> — Body: <code>{ catalogId }</code>. Purchase broker from system.</p>
<h3>3b) Car Racing Marketplace (Cars for sale)</h3>
<p><strong>GET</strong> <code>/api/car-racing/listings</code> — Active car listings from players. <strong>GET</strong> <code>/api/car-racing/system-cars</code> — Catalog of cars sold by system (AIBA). <strong>POST</strong> <code>/api/car-racing/list</code> — Body: <code>{ carId, priceAIBA }</code>. List your car for sale. <strong>POST</strong> <code>/api/car-racing/buy-car</code> — Body: <code>{ listingId, requestId }</code>. Buy car from player listing. <strong>POST</strong> <code>/api/car-racing/buy-system-car</code> — Body: <code>{ catalogId }</code>. Purchase car from system.</p>
<h3>3c) Bike Racing Marketplace (Bikes for sale)</h3>
<p><strong>GET</strong> <code>/api/bike-racing/listings</code> — Active bike listings from players. <strong>GET</strong> <code>/api/bike-racing/system-bikes</code> — Catalog of bikes sold by system (AIBA). <strong>POST</strong> <code>/api/bike-racing/list</code> — Body: <code>{ bikeId, priceAIBA }</code>. List your bike for sale. <strong>POST</strong> <code>/api/bike-racing/buy-bike</code> — Body: <code>{ listingId, requestId }</code>. Buy bike from player listing. <strong>POST</strong> <code>/api/bike-racing/buy-system-bike</code> — Body: <code>{ catalogId }</code>. Purchase bike from system.</p>
<h3>3d) Asset Marketplace (NFT Assets)</h3>
<p><strong>GET</strong> <code>/api/asset-marketplace/listings</code> Query: <code>listingType</code> Returns <code>{ listings: AssetListing[] }</code></p>
<p><strong>GET</strong> <code>/api/asset-marketplace/onchain-info</code> Query: <code>listingId</code> Returns <code>{ listingId, priceAiba, escrowAddress, escrowJettonWallet, jettonMaster }</code></p>
<p><strong>POST</strong> <code>/api/asset-marketplace/list</code> Body: <code>{ assetId, priceAiba, listingType }</code> Returns <code>{ listing }</code></p>
<p><strong>POST</strong> <code>/api/asset-marketplace/buy</code> Body: <code>{ listingId }</code> Returns <code>{ ok: true, asset }</code></p>
<p><strong>POST</strong> <code>/api/asset-marketplace/rent</code> Body: <code>{ listingId, durationHours }</code> Returns <code>{ rental }</code></p>
<hr/>
<h2>4) Governance (DAO)</h2>
<p><strong>GET</strong> <code>/api/dao/proposals</code> Query: <code>limit</code>, <code>status</code> (active|closed) Returns proposals with votesFor, votesAgainst.</p>
<p><strong>GET</strong> <code>/api/dao/proposals/:id</code> Returns single proposal with vote counts and myVote.</p>
<p><strong>POST</strong> <code>/api/dao/proposals</code> Body: <code>{ title, description?, type?, recipientTelegramId?, payoutAiba?, payoutNeur? }</code> Returns <code>{ proposal }</code></p>
<p><strong>Staking requirement:</strong> User must have staked ≥ <code>daoProposalMinStakedAiba</code> (default 10,000 AIBA) for ≥ <code>daoProposalMinStakeDays</code> (default 30 days) to create proposals. Configure in Admin → Economy. If not met: 403 <code>staking_required</code>.</p>
<p><strong>POST</strong> <code>/api/dao/vote</code> Body: <code>{ proposalId, support: true|false }</code> Returns <code>{ ok: true }</code>. One vote per user per proposal; can change vote.</p>
<p><strong>PATCH</strong> <code>/api/dao/proposals/:id/close</code> — Admin: close proposal <strong>POST</strong> <code>/api/dao/proposals/:id/execute</code> — Admin: execute treasury_payout</p>
<hr/>
<h2>5) Treasury &amp; Telemetry</h2>
<p><strong>GET</strong> <code>/api/treasury/summary</code> Returns <code>{ balanceAiba, balanceNeur, totalPaidOutAiba, totalPaidOutNeur }</code></p>
<p><strong>GET</strong> <code>/api/treasury/ops</code> Returns <code>{ ops: TreasuryOp[] }</code></p>
<p><strong>GET</strong> <code>/api/comms/status</code> — Returns <code>{ status: &quot;operational&quot;, updatedAt }</code> <strong>GET</strong> <code>/api/comms/config</code> — Returns <code>{ supportLink, supportTelegramGroup }</code> (Admin → Economy)</p>
<h3>Announcements &amp; Support (Unified Comms)</h3>
<p><strong>GET</strong> <code>/api/announcements</code> Query: <code>limit</code>. Returns <code>{ announcements[], unreadCount }</code> (unread = newer than user's lastSeenAnnouncementId). <strong>POST</strong> <code>/api/announcements/seen</code> — Body: <code>{ announcementId }</code>. Mark as read; updates lastSeenAnnouncementId. <strong>POST</strong> <code>/api/support/request</code> — Body: <code>{ subject, message }</code>. Submit support request; admins view in Admin → Support. <code>subject</code> must be one of: <code>question</code>, <code>bug</code>, <code>feature</code>, <code>account</code>, <code>other</code> (case-insensitive; invalid → <code>other</code>).</p>
<hr/>
<h2>5a) Trainers (Global Network, Dashboard, Leaderboard)</h2>
<p><strong>GET</strong> <code>/api/trainers/me</code> — My trainer stats (auth) <strong>POST</strong> <code>/api/trainers/apply</code> — Apply to become trainer; body <code>{ ref? }</code> <strong>GET</strong> <code>/api/trainers/network</code> — Public; query <code>sort</code>, <code>limit</code> <strong>GET</strong> <code>/api/trainers/leaderboard</code> — Public; query <code>by</code>, <code>limit</code> <strong>PATCH</strong> <code>/api/trainers/profile</code> — Update displayName, bio, specialty, region (auth) <strong>POST</strong> <code>/api/trainers/claim-rewards</code> — Claim pending AIBA (auth) <strong>POST</strong> <code>/api/trainers/register-use</code> — Record referee (auth) <strong>GET</strong> <code>/api/trainers/recruit-link</code> — Query <code>ref</code>; returns <code>{ url, ref }</code> <strong>Admin:</strong> <code>GET /api/admin/trainers</code>, <code>PATCH /api/admin/trainers/:id</code> (status: approve/suspend)</p>
<hr/>
<h2>5b) P2P AIBA &amp; Buy AIBA with TON</h2>
<p>All transaction charges (TON) go to Super Admin wallets. Use any TON-supported wallet.</p>
<p><strong>See <a href="SUPER-ADMIN-WALLETS.md">SUPER-ADMIN-WALLETS.md</a> for complete reference (all flows, env vars, config keys).</strong></p>
<p><strong>GET</strong> <code>/api/oracle/price</code> — Returns <code>{ aibaPerTon, neurPerAiba, updatedAt }</code> (AIBA per TON from automated oracle or manual config) <strong>GET</strong> <code>/api/p2p-aiba/config</code> — Fees (p2pSendFeeTonNano, buyFeeBps, aibaInGiftsFeeTonNano), oracle, wallet presence <strong>POST</strong> <code>/api/p2p-aiba/send</code> — Body: <code>{ toTelegramId?, toUsername?, amountAiba, txHash }</code> — Tx charge → <strong>P2P AIBA send</strong> (P2P_AIBA_SEND_WALLET); send AIBA to recipient <strong>POST</strong> <code>/api/p2p-aiba/buy</code> — Body: <code>{ txHash }</code> — Tx charge → <strong>Buy AIBA with TON</strong> (BUY_AIBA_WITH_TON_WALLET); receive AIBA at oracle rate minus fee</p>
<hr/>
<h2>5c) Gifts (extended)</h2>
<p><strong>POST</strong> <code>/api/gifts/send-aiba</code> — Body: <code>{ txHash, toTelegramId?, toUsername?, amountAiba, message? }</code> — Pay TON + fee → <strong>AIBA in gifts</strong> (AIBA_IN_GIFTS_WALLET); recipient receives AIBA. Tx charge to Super Admin.</p>
<hr/>
<h2>5d) Staking</h2>
<p><strong>GET</strong> <code>/api/staking/summary</code> — Auth. Returns <code>{ stakedAmount, apyPercent, lastClaimedAt, lockedAt, pendingReward }</code> <strong>GET</strong> <code>/api/staking/periods</code> — Returns <code>{ periods: [{ days, apyPercent }], minAiba }</code> (configurable; default min 100 AIBA, 30/90/180/365 days). <code>minAiba</code> = minimum stake (flexible + locked); ecosystem-aligned: Admin → Economy. <strong>GET</strong> <code>/api/staking/locks</code> — Auth. Returns user's period-based locks (StakingLock[]) <strong>POST</strong> <code>/api/staking/stake</code> — Body: <code>{ amount }</code>. Flexible staking (no lock period). Min: <code>stakingMinAiba</code> (default 100 AIBA). If below min: 400 <code>min_stake_required</code>. <strong>POST</strong> <code>/api/staking/unstake</code> — Body: <code>{ amount, requestId }</code>. Unstake flexible amount. <strong>POST</strong> <code>/api/staking/stake-locked</code> — Body: <code>{ amount, periodDays, requestId }</code>. Lock AIBA for period; returns <code>{ lock, expectedRewardAiba }</code>. Min: <code>stakingMinAiba</code> (default 100 AIBA). If below min: 400 <code>min_stake_required</code>. <strong>POST</strong> <code>/api/staking/cancel-early</code> — Body: <code>{ lockId, requestId }</code>. Cancel lock before period ends; fee (default 5% = 500 bps) → Treasury (CANCELLED_STAKES_WALLET). Returns <code>{ returnedAiba, feeAiba }</code>. <strong>POST</strong> <code>/api/staking/claim-lock</code> — Body: <code>{ lockId, requestId }</code>. When lock matured, claim principal + rewards. <strong>POST</strong> <code>/api/staking/claim</code> — Body: <code>{ requestId }</code>. Claim flexible-staking pending rewards.</p>
<p>Config: <code>stakingApyPercent</code>, <code>stakingMinAiba</code>, <code>stakingPeriods</code>, <code>stakingCancelEarlyFeeBps</code> (Admin → Economy; PATCH <code>/api/admin/economy/config</code>). <code>stakingMinAiba</code> = min AIBA to stake (flexible + locked; default 100, ecosystem-aligned: 1T AIBA, broker mint cost). Min displayed in Yield Vault hero, locked/flexible staking, and Wallet tab staking flow. See <a href="SUPER-ADMIN-WALLETS.md">SUPER-ADMIN-WALLETS.md</a> for CANCELLED_STAKES_WALLET.</p>
<hr/>
<h2>5e) Predict / Bet (Battle of the hour)</h2>
<p>Users bet AIBA on which broker scores higher. Vig (default 3%) → treasury.</p>
<p><strong>GET</strong> <code>/api/predict/events</code> — List open (or resolved) events <strong>GET</strong> <code>/api/predict/events/:id</code> — Single event with bet count <strong>POST</strong> <code>/api/predict/events/:id/bet</code> — Body: <code>{ brokerId, amountAiba }</code> — Place bet (max per Economy config) <strong>Admin:</strong> <code>POST /api/admin/predict/events</code> (create), <code>POST /api/admin/predict/events/:id/resolve</code> (run battle, pay winners, vig → TreasuryOp)</p>
<p>Config: <code>predictVigBps</code>, <code>predictMaxBetAiba</code> (Admin → Economy).</p>
<hr/>
<h2>5f) Creator Economy</h2>
<p>Referrers earn % of their referrals' battle, race, tournament, and global boss rewards. Tier-based: 100 refs = 3%, 1k = 5%, 10k = 7% (configurable).</p>
<p>Implemented in: battle, car racing, bike racing, tournaments, global boss reward distribution. Config: <code>creatorPercentBps</code>, <code>creatorTier100RefsBps</code>, <code>creatorTier1000RefsBps</code>, <code>creatorTier10000RefsBps</code>.</p>
<hr/>
<h2>5g) Donate (broker, car, bike, gifts)</h2>
<p>Tx charge (TON) → Super Admin wallet per type. <strong>See <a href="SUPER-ADMIN-WALLETS.md">SUPER-ADMIN-WALLETS.md</a> for env vars and config.</strong></p>
<p><strong>GET</strong> <code>/api/donate/config</code> — Fee amounts (donateBrokerFeeTonNano, etc.), wallet presence <strong>POST</strong> <code>/api/donate/broker</code> — Body: <code>{ brokerId, txHash }</code> — Tx charge → <strong>DONATE A BROKER</strong> (DONATE_BROKER_WALLET) <strong>POST</strong> <code>/api/donate/car</code> — Body: <code>{ carId, txHash }</code> — Tx charge → <strong>DONATE A CAR</strong> (DONATE_CAR_WALLET) <strong>POST</strong> <code>/api/donate/bike</code> — Body: <code>{ bikeId, txHash }</code> — Tx charge → <strong>DONATE A BIKE</strong> (DONATE_BIKE_WALLET) <strong>POST</strong> <code>/api/donate/gifts</code> — Body: <code>{ txHash }</code> — Tx charge → <strong>DONATE GIFTS</strong> (DONATE_GIFTS_WALLET)</p>
<hr/>
<h2>6) Admin (ops tuning)</h2>
<p><strong>GET</strong> <code>/api/admin/realms</code> <strong>POST</strong> <code>/api/admin/realms</code> (create/update)</p>
<p><strong>GET</strong> <code>/api/admin/economy/config</code> <strong>PATCH</strong> <code>/api/admin/economy/config</code> <strong>GET</strong> <code>/api/admin/economy/day</code> <strong>GET</strong> <code>/api/admin/economy/ledger</code> <strong>GET</strong> <code>/api/admin/economy/simulate</code> <strong>POST</strong> <code>/api/admin/economy/credit-user</code></p>
<p><strong>GET</strong> <code>/api/admin/marketplace/metrics</code> <strong>GET</strong> <code>/api/admin/treasury</code> <strong>POST</strong> <code>/api/admin/treasury/fund</code> <strong>GET</strong> <code>/api/admin/treasury/reserve</code> <strong>POST</strong> <code>/api/admin/treasury/reserve/fund</code> <strong>GET</strong> <code>/api/admin/treasury/buyback</code> <strong>POST</strong> <code>/api/admin/treasury/buyback/fund</code> <strong>PATCH</strong> <code>/api/admin/treasury/oracle</code> — Manual oracleAibaPerTon / oracleNeurPerAiba (one-off override) <strong>GET</strong> <code>/api/admin/oracle/status</code> — Oracle config (auto-update, aibaUsd, min/max/fallback, lastUpdatedAt) <strong>POST</strong> <code>/api/admin/oracle/update</code> — Trigger one oracle update cycle (fetches TON price, computes AIBA/TON, persists) <strong>GET</strong> <code>/api/admin/treasury-ops/metrics</code></p>
<hr/>
<h2>Types (summary)</h2>
<ul>
<li><strong>Mission</strong>: <code>{ realmKey, title, description, type, rewardAiba, rewardNeur, xp, order, requirements, active }</code></li>
<li><strong>Mentor</strong>: <code>{ key, name, realmKey, tier, description, perks[], stakingRequiredAiba, active }</code></li>
<li><strong>Asset</strong>: <code>{ ownerId, category, name, realmKey, rarity, level, upgradeCount, status, metadataUri, stats }</code></li>
<li><strong>AssetListing</strong>: <code>{ assetId, sellerId, priceAiba, listingType, status, feeBps, expiresAt }</code></li>
<li><strong>Rental</strong>: <code>{ assetId, ownerId, renterId, priceAiba, durationHours, status, startedAt, endsAt }</code></li>
<li><strong>GovernanceProposal</strong>: <code>{ title, description, status, votesFor, votesAgainst, startAt, endAt, actions[] }</code></li>
<li><strong>TreasuryOp</strong>: <code>{ type, amountAiba, source, refId }</code></li>
</ul>
  </div>
</body>
</html>