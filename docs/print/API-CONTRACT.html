<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>API CONTRACT — Aiba Arena Docs</title>
  <link rel="stylesheet" href="../print.css"/>
</head>
<body>
  <div class="doc-header">
    <h1>API CONTRACT</h1>
    <p class="doc-meta no-print"><a href="index.html">← All docs</a></p>
  </div>
  <div class="doc-body">
<h1>API Contract — Multiverse Expansion</h1>
<p><strong>Version:</strong> Feb 2025 <strong>Status:</strong> Phase 1 baseline (schemas + endpoints for new systems).</p>
<p>This document defines the <strong>API surface</strong> for Realms, Missions, Mentors, Assets, Marketplace, Governance, and Treasury telemetry.</p>
<hr/>
<h2>1) Realms &amp; Missions</h2>
<p><strong>GET</strong> <code>/api/realms</code> Returns <code>{ realms: Realm[] }</code></p>
<p><strong>GET</strong> <code>/api/realms/:key</code> Returns <code>{ realm: Realm }</code></p>
<p><strong>GET</strong> <code>/api/missions?realmKey=...</code> Returns <code>{ missions: Mission[] }</code></p>
<p><strong>POST</strong> <code>/api/missions/complete</code> Body: <code>{ missionId }</code> Returns <code>{ ok: true, rewardAiba, rewardNeur, xp }</code></p>
<hr/>
<h2>2) Mentors</h2>
<p><strong>GET</strong> <code>/api/mentors</code> Returns <code>{ mentors: Mentor[] }</code></p>
<p><strong>POST</strong> <code>/api/mentors/assign</code> Body: <code>{ mentorId }</code> Returns <code>{ ok: true }</code></p>
<p><strong>POST</strong> <code>/api/mentors/upgrade</code> Body: <code>{ mentorId }</code> Returns <code>{ ok: true, costAiba }</code></p>
<hr/>
<h2>3) Assets &amp; Marketplace</h2>
<p><strong>POST</strong> <code>/api/assets/mint</code> Body: <code>{ category, name, realmKey, metadataUri }</code> Returns <code>{ asset }</code></p>
<p><strong>POST</strong> <code>/api/assets/upgrade</code> Body: <code>{ assetId }</code> Returns <code>{ asset }</code></p>
<p><strong>GET</strong> <code>/api/assets/mine</code> Returns <code>{ assets: Asset[] }</code></p>
<h3>3a) Broker Marketplace (Brokers)</h3>
<p><strong>GET</strong> <code>/api/marketplace/listings</code> Query: <code>limit</code> Returns <code>Listing[]</code></p>
<p><strong>POST</strong> <code>/api/marketplace/list</code> Body: <code>{ brokerId, priceAIBA, priceNEUR }</code> Returns <code>Listing</code></p>
<p><strong>POST</strong> <code>/api/marketplace/delist</code> Body: <code>{ listingId }</code> Returns <code>{ ok: true, listing }</code></p>
<p><strong>POST</strong> <code>/api/marketplace/buy</code> Body: <code>{ listingId }</code> Returns <code>{ ok: true, broker, listingId }</code></p>
<h3>3b) Asset Marketplace (NFT Assets)</h3>
<p><strong>GET</strong> <code>/api/asset-marketplace/listings</code> Query: <code>listingType</code> Returns <code>{ listings: AssetListing[] }</code></p>
<p><strong>GET</strong> <code>/api/asset-marketplace/onchain-info</code> Query: <code>listingId</code> Returns <code>{ listingId, priceAiba, escrowAddress, escrowJettonWallet, jettonMaster }</code></p>
<p><strong>POST</strong> <code>/api/asset-marketplace/list</code> Body: <code>{ assetId, priceAiba, listingType }</code> Returns <code>{ listing }</code></p>
<p><strong>POST</strong> <code>/api/asset-marketplace/buy</code> Body: <code>{ listingId }</code> Returns <code>{ ok: true, asset }</code></p>
<p><strong>POST</strong> <code>/api/asset-marketplace/rent</code> Body: <code>{ listingId, durationHours }</code> Returns <code>{ rental }</code></p>
<hr/>
<h2>4) Governance</h2>
<p><strong>GET</strong> <code>/api/governance/proposals</code> Returns <code>{ proposals: GovernanceProposal[] }</code></p>
<p><strong>POST</strong> <code>/api/governance/propose</code> Body: <code>{ title, description, actions[] }</code> Returns <code>{ proposal }</code></p>
<p><strong>POST</strong> <code>/api/governance/vote</code> Body: <code>{ proposalId, vote: 'for'|'against' }</code> Returns <code>{ ok: true }</code></p>
<hr/>
<h2>5) Treasury &amp; Telemetry</h2>
<p><strong>GET</strong> <code>/api/treasury/summary</code> Returns <code>{ balanceAiba, balanceNeur, totalPaidOutAiba, totalPaidOutNeur }</code></p>
<p><strong>GET</strong> <code>/api/treasury/ops</code> Returns <code>{ ops: TreasuryOp[] }</code></p>
<p><strong>GET</strong> <code>/api/comms/status</code> Returns <code>{ status: &quot;operational&quot;, updatedAt }</code></p>
<hr/>
<h2>5a) Trainers (Global Network, Dashboard, Leaderboard)</h2>
<p><strong>GET</strong> <code>/api/trainers/me</code> — My trainer stats (auth) <strong>POST</strong> <code>/api/trainers/apply</code> — Apply to become trainer; body <code>{ ref? }</code> <strong>GET</strong> <code>/api/trainers/network</code> — Public; query <code>sort</code>, <code>limit</code> <strong>GET</strong> <code>/api/trainers/leaderboard</code> — Public; query <code>by</code>, <code>limit</code> <strong>PATCH</strong> <code>/api/trainers/profile</code> — Update displayName, bio, specialty, region (auth) <strong>POST</strong> <code>/api/trainers/claim-rewards</code> — Claim pending AIBA (auth) <strong>POST</strong> <code>/api/trainers/register-use</code> — Record referee (auth) <strong>GET</strong> <code>/api/trainers/recruit-link</code> — Query <code>ref</code>; returns <code>{ url, ref }</code> <strong>Admin:</strong> <code>GET /api/admin/trainers</code>, <code>PATCH /api/admin/trainers/:id</code> (status: approve/suspend)</p>
<hr/>
<h2>5b) P2P AIBA &amp; Buy AIBA with TON</h2>
<p><strong>GET</strong> <code>/api/oracle/price</code> — Returns <code>{ aibaPerTon, neurPerAiba, updatedAt }</code> (AIBA per TON from automated oracle or manual config) <strong>GET</strong> <code>/api/p2p-aiba/config</code> — Fees, oracle, wallet presence <strong>POST</strong> <code>/api/p2p-aiba/send</code> — Body: <code>{ toTelegramId?, toUsername?, amountAiba, txHash }</code> — Pay TON fee → P2P_AIBA_SEND_WALLET; send AIBA to recipient <strong>POST</strong> <code>/api/p2p-aiba/buy</code> — Body: <code>{ txHash }</code> — Pay TON → BUY_AIBA_WITH_TON_WALLET; receive AIBA at oracle rate minus fee</p>
<hr/>
<h2>5c) Gifts (extended)</h2>
<p><strong>POST</strong> <code>/api/gifts/send-aiba</code> — Body: <code>{ txHash, toTelegramId?, toUsername?, amountAiba, message? }</code> — Pay TON → AIBA_IN_GIFTS_WALLET; recipient receives AIBA</p>
<hr/>
<h2>5d) Donate (broker, car, bike, gifts)</h2>
<p><strong>GET</strong> <code>/api/donate/config</code> — Fee amounts, wallet presence <strong>POST</strong> <code>/api/donate/broker</code> — Body: <code>{ brokerId, txHash }</code> — TON fee → DONATE_BROKER_WALLET <strong>POST</strong> <code>/api/donate/car</code> — Body: <code>{ carId, txHash }</code> — TON fee → DONATE_CAR_WALLET <strong>POST</strong> <code>/api/donate/bike</code> — Body: <code>{ bikeId, txHash }</code> — TON fee → DONATE_BIKE_WALLET <strong>POST</strong> <code>/api/donate/gifts</code> — Body: <code>{ txHash }</code> — TON fee → DONATE_GIFTS_WALLET</p>
<hr/>
<h2>6) Admin (ops tuning)</h2>
<p><strong>GET</strong> <code>/api/admin/realms</code> <strong>POST</strong> <code>/api/admin/realms</code> (create/update)</p>
<p><strong>GET</strong> <code>/api/admin/economy/config</code> <strong>PATCH</strong> <code>/api/admin/economy/config</code> <strong>GET</strong> <code>/api/admin/economy/day</code> <strong>GET</strong> <code>/api/admin/economy/ledger</code> <strong>GET</strong> <code>/api/admin/economy/simulate</code> <strong>POST</strong> <code>/api/admin/economy/credit-user</code></p>
<p><strong>GET</strong> <code>/api/admin/marketplace/metrics</code> <strong>GET</strong> <code>/api/admin/treasury</code> <strong>POST</strong> <code>/api/admin/treasury/fund</code> <strong>GET</strong> <code>/api/admin/treasury/reserve</code> <strong>POST</strong> <code>/api/admin/treasury/reserve/fund</code> <strong>GET</strong> <code>/api/admin/treasury/buyback</code> <strong>POST</strong> <code>/api/admin/treasury/buyback/fund</code> <strong>PATCH</strong> <code>/api/admin/treasury/oracle</code> — Manual oracleAibaPerTon / oracleNeurPerAiba (one-off override) <strong>GET</strong> <code>/api/admin/oracle/status</code> — Oracle config (auto-update, aibaUsd, min/max/fallback, lastUpdatedAt) <strong>POST</strong> <code>/api/admin/oracle/update</code> — Trigger one oracle update cycle (fetches TON price, computes AIBA/TON, persists) <strong>GET</strong> <code>/api/admin/treasury-ops/metrics</code></p>
<hr/>
<h2>Types (summary)</h2>
<ul>
<li><strong>Mission</strong>: <code>{ realmKey, title, description, type, rewardAiba, rewardNeur, xp, order, requirements, active }</code></li>
<li><strong>Mentor</strong>: <code>{ key, name, realmKey, tier, description, perks[], stakingRequiredAiba, active }</code></li>
<li><strong>Asset</strong>: <code>{ ownerId, category, name, realmKey, rarity, level, upgradeCount, status, metadataUri, stats }</code></li>
<li><strong>AssetListing</strong>: <code>{ assetId, sellerId, priceAiba, listingType, status, feeBps, expiresAt }</code></li>
<li><strong>Rental</strong>: <code>{ assetId, ownerId, renterId, priceAiba, durationHours, status, startedAt, endsAt }</code></li>
<li><strong>GovernanceProposal</strong>: <code>{ title, description, status, votesFor, votesAgainst, startAt, endAt, actions[] }</code></li>
<li><strong>TreasuryOp</strong>: <code>{ type, amountAiba, source, refId }</code></li>
</ul>
  </div>
</body>
</html>