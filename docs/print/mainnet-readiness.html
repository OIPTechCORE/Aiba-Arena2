<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>mainnet readiness — Aiba Arena Docs</title>
  <link rel="stylesheet" href="../print.css"/>
</head>
<body>
  <div class="doc-header">
    <h1>mainnet readiness</h1>
    <p class="doc-meta no-print"><a href="index.html">← All docs</a></p>
  </div>
  <div class="doc-body">
<h1>Mainnet Readiness Checklist</h1>
<p>This checklist is the minimum bar before deploying Aiba Arena contracts and backend to mainnet.</p>
<h2>Key management</h2>
<ul>
<li>- Contract deployer key</li>
<li>- Reward-claim signer/oracle key (<code>ORACLE_PRIVATE_KEY_HEX</code>)</li>
<li>- Admin JWT signing secret (<code>ADMIN_JWT_SECRET</code>)</li>
<li>- Telegram bot token (<code>TELEGRAM_BOT_TOKEN</code>)</li>
<li><strong>Never store secrets in the repo</strong></li>
<li>- Use a secret manager (Vercel/Render/Railway secrets, Vault, AWS/GCP secrets manager)</li>
<li>- Rotate any keys that ever touched a developer machine</li>
<li><strong>Signing isolation</strong></li>
<li>- Move reward-claim signing behind a dedicated signing service or KMS/HSM</li>
<li>- Enforce strict allow-lists (vault address, jetton master, max amount per claim, max claims per user/day)</li>
<li><strong>Rotation plan</strong></li>
<li>- Document and rehearse rotation for <code>ORACLE_PRIVATE_KEY_HEX</code> (requires updating oracle key on-chain)</li>
<li>- Keep old key available for rollback only, time-boxed</li>
</ul>
<h2>Validation defaults (backend)</h2>
<p>These defaults apply when env vars are unset; <strong>production should set them explicitly</strong> (enforced by production readiness checks where noted).</p>
<ul>
<li>- When <code>TELEGRAM_INITDATA_MAX_AGE_SECONDS</code> is unset or invalid: <strong>900 seconds</strong> (15 minutes)</li>
<li>- Production: <strong>must be set explicitly</strong> (fail-fast in <code>productionReadiness.js</code>); recommended 300–900 seconds</li>
<li><strong>CORS</strong></li>
<li>- When <code>CORS_ORIGIN</code> is unset: allow-all (insecure for prod)</li>
<li>- Production: <strong>must be set</strong> to a comma-separated allow-list (fail-fast)</li>
<li><strong>Admin auth</strong></li>
<li>- Production: <strong>ADMIN_PASSWORD_HASH</strong> required; <strong>ADMIN_PASSWORD</strong> (plaintext) disallowed (fail-fast)</li>
<li><strong>Battle seed</strong></li>
<li>- Production: <strong>BATTLE_SEED_SECRET</strong> must be ≥ 32 chars, not dev placeholder (fail-fast)</li>
<li><strong>Vault/claims</strong></li>
<li>- When any of <code>ARENA_VAULT_ADDRESS</code>, <code>AIBA_JETTON_MASTER</code>, <code>ORACLE_PRIVATE_KEY_HEX</code> is set: all three required; <strong>TON_PROVIDER_URL</strong> required and must not be testnet (fail-fast)</li>
</ul>
<h2>Stricter validations (backend)</h2>
<ul>
<li>- Enforce <code>initData</code> verification on all user routes</li>
<li>- Set <code>TELEGRAM_INITDATA_MAX_AGE_SECONDS</code> to a conservative value (recommended 300–900 seconds)</li>
<li>- Default when unset is <strong>900 seconds</strong> (see <code>backend/security/telegramPolicy.js</code>); production must set explicitly</li>
<li>- Disable any dev shortcuts on production (<code>APP_ENV</code> must not be <code>dev</code>/<code>test</code>; when <code>APP_ENV=dev</code>/<code>test</code>, prod checks are skipped)</li>
<li><strong>Input validation</strong></li>
<li>- Validate all route inputs (types, bounds, enums) server-side</li>
<li>- Reject unknown fields on admin PATCH/POST endpoints (avoid “silent config drift”)</li>
<li>- Implemented for <code>PATCH /api/admin/economy/config</code> when <code>APP_ENV=prod</code> or <code>NODE_ENV=production</code></li>
<li><strong>Idempotency &amp; replay protection</strong></li>
<li>- Require idempotency keys for battle settlement and economy mutations</li>
<li>- Ensure retries cannot double-charge or double-credit</li>
<li>- Implemented for economy credits/debits by creating the ledger row first (duplicate-safe) and only applying balance/counter changes once</li>
<li><strong>Rate limiting</strong></li>
<li>- Replace in-memory rate limiting with a shared store (Redis) for multi-instance deployments</li>
</ul>
<h2>Secrets &amp; required production env (backend)</h2>
<ul>
<li><code>TELEGRAM_BOT_TOKEN</code> (auth + push notifications)</li>
<li><code>BOOST_TON_WALLET</code> (optional; TON wallet for boost payments; cost set in Admin → Economy as <code>boostCostTonNano</code>)</li>
<li><code>TELEGRAM_INITDATA_MAX_AGE_SECONDS</code> (set explicitly; do not rely on defaults)</li>
<li><code>BATTLE_SEED_SECRET</code> (must be a strong secret; never use dev defaults)</li>
<li><code>ADMIN_JWT_SECRET</code>, <code>ADMIN_EMAIL</code>, <code>ADMIN_PASSWORD_HASH</code></li>
<li>Vault/claims:</li>
<li>- <code>ARENA_VAULT_ADDRESS</code></li>
<li>- <code>AIBA_JETTON_MASTER</code></li>
<li>- <code>ORACLE_PRIVATE_KEY_HEX</code></li>
<li>- TON reads: <code>TON_PROVIDER_URL</code>, <code>TON_API_KEY</code></li>
</ul>
<h2>Checklist enforcement (fail-fast)</h2>
<p>When <code>APP_ENV=prod</code> or <code>NODE_ENV=production</code>, the backend performs startup checks and <strong>exits non-zero</strong> if unsafe or missing configuration is detected (see <code>backend/security/productionReadiness.js</code>). When <code>APP_ENV=dev</code> or <code>APP_ENV=test</code>, production checks are <strong>skipped</strong> (allows staging/Vercel with incomplete prod env).</p>
<p>Enforced today:</p>
<ul>
<li>- Requires <code>CORS_ORIGIN</code> (unset defaults to allow-all in code; prod fails without it)</li>
<li><strong>Telegram replay/age protection</strong></li>
<li>- Requires <code>TELEGRAM_INITDATA_MAX_AGE_SECONDS</code> to be set explicitly and \&gt; 0</li>
<li><strong>Admin auth hardening</strong></li>
<li>- Requires <code>ADMIN_PASSWORD_HASH</code> (disallows relying on plaintext <code>ADMIN_PASSWORD</code>)</li>
<li>- Blocks weak/placeholder <code>ADMIN_JWT_SECRET</code> (minimum 32 chars)</li>
<li><strong>Deterministic battle secret</strong></li>
<li>- Blocks dev/weak <code>BATTLE_SEED_SECRET</code> (minimum 32 chars)</li>
<li><strong>Vault/claims config sanity</strong></li>
<li>- Requires vault env to be “all-or-nothing” (<code>ARENA_VAULT_ADDRESS</code>, <code>AIBA_JETTON_MASTER</code>, <code>ORACLE_PRIVATE_KEY_HEX</code>)</li>
<li>- Requires explicit <code>TON_PROVIDER_URL</code> and blocks obvious testnet endpoints when vault/claims are configured</li>
<li>- Validates <code>ORACLE_PRIVATE_KEY_HEX</code> is 64 hex chars (32 bytes)</li>
<li><strong>Legacy dispatch</strong></li>
<li>- Blocks <code>ENABLE_LEGACY_PENDING_AIBA_DISPATCH=true</code> in production (signed claims only)</li>
</ul>
<h2>Security review steps</h2>
<ul>
<li>- Vault claim verification invariants (recipient binding, seqno, expiry)</li>
<li>- Marketplace escrow invariants (sender validation, refund paths, fee correctness)</li>
<li>- NFT transfer callbacks and bounce handling</li>
<li><strong>Backend review</strong></li>
<li>- No secrets in logs</li>
<li>- Strict CORS allow-list (<code>CORS_ORIGIN</code>) and <code>trust proxy</code> correctness</li>
<li>- Admin auth hardening (password hashing parameters, token expiry, refresh strategy)</li>
<li>- Database indexes for all high-volume queries</li>
<li><strong>Operational readiness</strong></li>
<li>- Monitoring and alerting configured (uptime <code>/health</code>, scraping <code>/metrics</code>, vault inventory checks)</li>
<li>- Backups enabled (MongoDB Atlas snapshots) and restore tested</li>
<li>- Runbook updated (<code>docs/runbook.md</code>)</li>
</ul>
  </div>
</body>
</html>